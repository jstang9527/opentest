package service

import (
	"encoding/json"
	"fmt"
	"net/http"

	"github.com/jstang9527/opentest/model"
	"github.com/jstang9527/opentest/utils/dbdao"
)

// ProjectResponse ...
type projectResponse struct {
	Code int //必须大写,因为要传给json序列化
	Msg  string
	Data []*model.Project
}

// ProjectResponseRow ...
type projectResponseRow struct {
	Code int
	Msg  string
	Data *model.Project
}

// Project ...
func Project(w http.ResponseWriter, r *http.Request) {
	method := r.Method
	switch method {
	case "GET":
		// fmt.Println("get", method)
		getProject(w, r)
	case "POST":
		fmt.Println("Post", method)
	case "PUT":
		fmt.Println("Put", method)
	case "DELETE":
		fmt.Println("Delete", method)
	default:
		fmt.Println("Unkhown", method)
	}

}

func getProject(w http.ResponseWriter, r *http.Request) {
	// r.URL.Query()["id"]
	// temMap := make(map[string]interface{})
	var responseData []byte
	id := r.URL.Query().Get("id")
	if id == "" { //不给ID查全部
		sql := `select * from project`
		if pros, err := dbdao.QueryManyRowProject(sql); err != nil {
			pr := projectResponse{
				Code: http.StatusServiceUnavailable,
				Msg:  fmt.Sprint(err),
			}
			responseData, _ = json.Marshal(pr)
		} else {
			pr := projectResponse{
				Code: http.StatusOK,
				Msg:  "success",
				Data: pros,
			}
			responseData, _ = json.Marshal(pr)
		}
	} else {
		sql := fmt.Sprintf(`select * from project where project_id ="%v"`, id)
		if d, err := dbdao.QueryRowProject(sql); err != nil {
			pr := projectResponse{
				Code: http.StatusServiceUnavailable,
				Msg:  fmt.Sprint(err),
			}
			responseData, _ = json.Marshal(pr)
		} else {
			pr := projectResponseRow{
				Code: http.StatusOK, //必须大写,因为要传给json序列化
				Msg:  "success",
				Data: d,
			}
			responseData, _ = json.Marshal(pr)
		}
	}
	w.Write(responseData)
}
