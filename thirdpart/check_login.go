package thirdpart

import (
	"fmt"
	"strings"
	"time"

	"github.com/jstang9527/opentest/utils/tools"

	mops "github.com/jstang9527/opentest/ops"

	"github.com/jstang9527/opentest/model"
	"github.com/tebeka/selenium"
)

// IndexLogin ...
func (t *TestTask) checkLogin() error {
	name := "login"
	var message string
	var priority model.Level = model.High
	start := time.Now()

	defer func() {
		mops.Console("login operation finished.")
	}()
	//1.找到用户输入框id
	userName, err := t.Wd.FindElement(selenium.ByID, "userAccount")
	if err == nil {
		userName.SendKeys("adminantiy")
		mops.Console("input username success in login page.")
	} else {
		message = fmt.Sprint("username input not found in login page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
		return err
	}

	//2.找到密码输入框id
	userPassword, err := t.Wd.FindElement(selenium.ByID, "userPassword")
	if err == nil {
		userPassword.SendKeys("antiylabsnode)9*")
		mops.Console("password input success in login page.")
	} else {
		message = fmt.Sprint("password input not found in login page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
		return err
	}

	//3.找到验证码输入框id
	verificationCode, err := t.Wd.FindElement(selenium.ByID, "verificationCode")
	if err == nil {
		verificationCode.SendKeys("1234")
		mops.Console("input auth code success in login page.")
	} else {
		message = fmt.Sprint("auth'code input not found in login page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
		return err
	}

	//4.找到提交按钮id
	login, err := t.Wd.FindElement(selenium.ByXPATH, `//*[@id="root"]/div/div[2]/div[2]/form/div[4]/div/div/span/button`)
	if err == nil {
		//找到就点击提交
		login.Click()
		mops.Console("login success.")
	} else {
		//找不到提交按钮，xpath出错咯
		message = fmt.Sprint("login buttom not found in login page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
		return err
	}
	//5.登录后->等待加载管理面板
	if err := t.laodwait(); err != nil {
		message = fmt.Sprint("load home page data, err: ", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
		return err
	}
	time.Sleep(time.Second * 3)
	//6.刷新页面
	t.Wd.Refresh()

	//7.抓进去后的url
	for i := 0; i < 10; i++ {
		time.Sleep(time.Millisecond * 300)
		cURL, _ := t.Wd.CurrentURL()
		mops.Console(cURL)
		if strings.HasSuffix(strings.TrimSpace(cURL), "overview") {
			mops.Console("already change url: %v", cURL)
			message = cURL
			break
		}
		if i == 9 {
			message := fmt.Sprint("can't change to index page by login.")
			screenshot := tools.CreateMd5(message) //截图名
			t.createItem(name, message, screenshot, priority, model.Fatal, time.Now().Sub(start))
			return err
		}
	}

	now := time.Now()
	screenshot := tools.CreateMd5(name + start.String() + now.String() + message) //截图名
	t.createItem(name, message, screenshot, priority, model.Pass, time.Now().Sub(start))
	return nil
}
