package selm

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"os"
	"regexp"
	"strings"
	"time"

	"github.com/TruthHun/html2json/html2json"
	"github.com/jstang9527/gateway/thirdpart/selm2"

	"github.com/jstang9527/gateway/dto"

	"github.com/jstang9527/gateway/thirdpart/es"

	"github.com/jstang9527/gateway/public"
	"github.com/jstang9527/opentest/utils/tools"
	"github.com/tebeka/selenium"

	"github.com/jstang9527/gateway/dao"
)

// ActionTask ...
type ActionTask struct {
	ProjectID   string        //md5
	ProjectName string        //detux
	ProjectAddr string        //https://gitlab.com/xxx
	WebAddr     string        // http://172.31.50.252:65000
	FuncName    string        //创建蜜罐
	Message     string        // OpenHomePage, err:nil, output: null  *
	Screenshot  string        //https://.....                         *
	Priority    int           // High
	Status      int           // Pass   123                           *
	Duration    time.Duration //                                      *
	Wd          selenium.WebDriver
}

// NewActionTask ...
func NewActionTask(bt *BlockTask, wd selenium.WebDriver) *ActionTask {
	return &ActionTask{
		ProjectID:   public.MD5(fmt.Sprintf("%v%v%v%v", bt.Params.ProjectName, bt.Params.ProjectAddr, bt.Params.WebAddr, bt.Params.StreamID)),
		ProjectName: bt.Params.ProjectName,
		ProjectAddr: bt.Params.ProjectAddr,
		WebAddr:     bt.Params.WebAddr,
		FuncName:    bt.BlockInfo.BlockName,
		Priority:    bt.BlockInfo.Priority,
		Wd:          wd,
	}
}

// ExecAction 执行具体动作
func (at *ActionTask) ExecAction(action *dao.ActionItem) (err error) {
	start := time.Now()
	status := 1
	message := "" //接收抓取的数据

	//1.根据操作类型执行对应操作函数, 输入事件|点击事件|页面跳转事件|指标监控事件|数据抓取事件
	switch action.EventType {
	case entry:
		err = at.EntryAction(action)
	case input:
		err = at.InputAction(action)
	case click:
		err = at.ClickAction(action)
	case monitor:
		err = at.MonitorAction(action)
	case parse:
		message, err = at.ParseAction(action)
	default:
		err = fmt.Errorf("params eleType not in [entry,input,click,monitor,parse]")
		status = 2
	}
	//2.判断出错与否
	if err != nil { //有错
		if status != 2 { //非人为写错
			status = 3
		}
	}
	//3.把正确或者错误的结果存起来
	if message != "" { //output输出
		message = fmt.Sprintf("%v, quota: %v, err: %v, output: %v.", action.ActionName, action.ElementValue, err, message)
	} else {
		message = fmt.Sprintf("%v, quota: %v, err: %v", action.ActionName, action.ElementValue, err)
	}
	screenshot := public.MD5(message) //截图名

	// 保存截图、异步推ES
	at.Save(message, screenshot, status, time.Now().Sub(start))
	return
}

// Save ...
func (at *ActionTask) Save(message, screenshot string, status int, dura time.Duration) {
	at.Message = message
	at.Screenshot = screenshot + ".png"
	at.Status = status
	at.Duration = dura
	fmt.Printf("%#v\n", at)
	//同步保存截图，否则at.wd会报错
	at.saveScreenshot()
	//异步推ES
	ti := dto.NewTestItem(at.ProjectID, at.ProjectName, at.ProjectAddr, at.WebAddr, at.FuncName, at.Message, at.Screenshot, at.Priority, at.Status, at.Duration)
	go es.SendToESChan(ti)
}

// 保存截图 ...(保存路径为服务器内文件路径, web访问路径非此路径)
func (at *ActionTask) saveScreenshot() {
	//创建存储项目id的截图目录
	dirPath := "./resources/" + at.ProjectID + "/"
	if bl, _ := tools.PathExists(dirPath); !bl {
		os.Mkdir(dirPath, 0666)
	}
	imgpath := dirPath + at.Screenshot
	time.Sleep(time.Millisecond * 200) //等0.8秒再截图

	if b, err := at.Wd.Screenshot(); err != nil {
		fmt.Printf("failed output screenshop by selenium, err: %v\n", err)
	} else {
		if err := ioutil.WriteFile(imgpath, b, 0666); err != nil {
			fmt.Printf("cann't save screenshot in local, err: %v\n", err)
			return
		}
	}
}

// EntryAction ...
func (at *ActionTask) EntryAction(action *dao.ActionItem) (err error) {
	url := at.WebAddr + action.URL // http://172.31.50.39:65000
	return at.Wd.Get(url)
}

// InputAction ...
func (at *ActionTask) InputAction(action *dao.ActionItem) (err error) {
	var ele selenium.WebElement
	//1.先判断是id还是xpath
	if action.SearchType == 1 {
		ele, err = at.Wd.FindElement(selenium.ByID, action.ElementID)
	} else if action.SearchType == 2 {
		ele, err = at.Wd.FindElement(selenium.ByXPATH, action.XPath)
	} else {
		return fmt.Errorf("unable found expect search type: %v; [1:byid, 2:xpath]", action.SearchType)
	}
	if err != nil {
		return fmt.Errorf("element not found, info: %v", err)
	}
	return ele.SendKeys(action.ElementValue)
}

// ClickAction ...
func (at *ActionTask) ClickAction(action *dao.ActionItem) (err error) {
	var ele selenium.WebElement
	//1.先判断是id还是xpath
	if action.SearchType == 1 {
		ele, err = at.Wd.FindElement(selenium.ByID, action.ElementID)
	} else if action.SearchType == 2 {
		ele, err = at.Wd.FindElement(selenium.ByXPATH, action.XPath)
	} else if action.SearchType == 3 {
		return at.AutoClick(action)
	} else {
		return fmt.Errorf("unable found expect search type: %v; [1:byid, 2:xpatj]", action.SearchType)
	}
	if err != nil {
		return fmt.Errorf("element not found, info: %v", err)
	}
	return ele.Click()
}

// /html/body/div[2]/div/span/div/div/div/span[2]
// /html/body/div[2]/div/span/div/div/div/span[2]
// /html/body/div[2]/div/span/div/div/div/span[2]
// /html/body/div[2]/div/span/div/div/div/span[2]
// .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;%JMETER_HOME%\lib\ext\ApacheJMeter_core.jar;%JMETER_HOME%\lib\jorphan.jar;

// MonitorAction 取消
func (at *ActionTask) MonitorAction(action *dao.ActionItem) (err error) {
	var ele selenium.WebElement
	var quota string
	start := time.Now()
	step := 1

	for i := 0; ; i++ {
		// 1.先判断是id还是xpath
		if action.SearchType == 1 {
			ele, err = at.Wd.FindElement(selenium.ByID, action.ElementID)
		} else {
			ele, err = at.Wd.FindElement(selenium.ByXPATH, action.XPath)
		}
		// 2.元素找不到
		if err != nil {
			if action.AllowErr == 1 { //允许,找不到视为正确
				return nil
			}
		} else { //找到元素
			quota, err = ele.Text()
			if err != nil {
				return fmt.Errorf("unable get text of element, info:%v", err)
			}
			reg := regexp.MustCompile(`\s{2,}|\n|\t|\r`)
			quota = reg.ReplaceAllString(quota, "")
			quota = strings.TrimSpace(quota)
			quota = strings.ToLower(quota)
			//满足指标退出
			if strings.Contains(quota, action.ElementValue) {
				// if quota == action.ElementValue {
				fmt.Printf("excpet: %v, output: %v\n", action.ElementValue, quota)
				return nil
			}
		}
		// 4.是否超过指定时间，超时找不到
		if time.Now().Sub(start) > time.Second*time.Duration(action.Timeout) {
			return fmt.Errorf("unable reach the quato [%v] in %d seconds", action.ElementValue, action.Timeout)
		}
		// 5.超过10秒找不到就刷新页面
		if i%100 == 0 {
			at.Wd.Refresh()
			time.Sleep(time.Second * time.Duration(step))
			if step < 5 {
				step++
			}
		}
		time.Sleep(time.Millisecond * 100)
	}
}

// ParseAction 抓数据, 看用户的value,没设置的话空则info,有设置的话Warning
func (at *ActionTask) ParseAction(action *dao.ActionItem) (result string, err error) {
	var ele selenium.WebElement
	//1.先判断是id还是xpath
	if action.SearchType == 1 {
		ele, err = at.Wd.FindElement(selenium.ByID, action.ElementID)
	} else if action.SearchType == 2 {
		ele, err = at.Wd.FindElement(selenium.ByXPATH, action.XPath)
	} else if action.SearchType == 3 {
		return "", at.TableOperation(action)
	} else {
		return "", fmt.Errorf("unable found expect search type: %v; [1:byid, 2:xpatj]", action.SearchType)
	}
	if err != nil {
		return "", fmt.Errorf("element not found, info: %v", err)
	}

	//2.抓数据
	rows, err := ele.FindElements(selenium.ByTagName, "tr")
	if err != nil {
		err = fmt.Errorf("element not found")
		return
	}
	for _, row := range rows {
		items, _ := row.FindElements(selenium.ByTagName, "td")
		for _, item := range items {
			text, _ := item.Text()
			result = fmt.Sprintf("%v, %v", result, strings.TrimSpace(text))
		}
	}
	reg := regexp.MustCompile(`\s{2,}|\n|\t|\r`)
	result = reg.ReplaceAllString(result, "")
	return
}

// AutoClick 只根据动作名匹配
func (at *ActionTask) AutoClick(action *dao.ActionItem) (err error) {
	s2 := &selm2.Action{Info: action.ActionName}
	// 获取html全节点对象
	h2j, err := at.GetHTMLNodeObj()
	if err != nil {
		return
	}
	if ok := s2.SearchText(h2j.Children); !ok {
		return fmt.Errorf("unable find key info in pagedata")
	}

	//检索到了
	var e1, e2, e3 error
	out := s2.Reverse().Replace().Selector().ToString()
	if out.Button != "" {
		we, err := at.Wd.FindElement(selenium.ByXPATH, out.Button)
		if err != nil { //有button还找出错了
			return err
		}
		e1 = we.Click()
	} else if out.Link != "" {
		we, err := at.Wd.FindElement(selenium.ByXPATH, out.Link)
		if err != nil {
			return err
		}
		e2 = we.Click()
	} else {
		we, err := at.Wd.FindElement(selenium.ByXPATH, out.Path)
		if err != nil {
			return err
		}
		e3 = we.Click()
	}
	// 三个都错
	if e1 != nil && e2 != nil && e3 != nil {
		return fmt.Errorf("auto click failed by link,button,path")
	}
	return
}

// TableOperation 表格对象操作
func (at *ActionTask) TableOperation(action *dao.ActionItem) (err error) {
	s2 := &selm2.Action{Info: action.ActionName}
	// 获取html全节点对象
	h2j, err := at.GetHTMLNodeObj()
	if err != nil {
		return
	}
	if ok := s2.SearchTable(h2j.Children); !ok {
		return fmt.Errorf("unable find table element")
	}
	// action.Node[0].Children[0] ->table标签信息
	table := s2.Node[0].Children[0]
	// var thead *selm2.H2j
	var tbody *selm2.H2j
	for _, item := range table.Children { //找thead、tbody
		if item.Name == "tbody" {
			tbody = item
			// fmt.Println("yes", item.Name)
			// fmt.Println("记录数", len(item.Children))
			continue
		}
		// if item.Name == "thead" {
		// 	thead = item
		// 	// fmt.Println("ok", item.Name)
		// 	// fmt.Println("字段数", len(item.Children[0].Children))
		// 	continue
		// }
	}
	out := s2.Reverse().Replace().Selector().ToString()
	svgXptah := fmt.Sprintf("%v/table/tbody/tr[1]/td[%v]", out.Path, len(tbody.Children[0].Children))
	// //*[@id="root"]/div/div/div[3]/div[2]/div[3]/div/div/div/div/div[1]/div/div/div/div/div/table/tbody/tr[1]/td[13]
	// //*[@id="root"]/div/div/div[3]/div[2]/div[3]/div/div/div/div/div[1]/div/div/div/div/div    -web
	fmt.Println(svgXptah)
	we, err := at.Wd.FindElement(selenium.ByXPATH, svgXptah)
	if err != nil {
		return
	}
	return we.Click()
}

// GetHTMLNodeObj 获取html的全节点对象
func (at *ActionTask) GetHTMLNodeObj() (resp *selm2.H2j, err error) {
	// at.Wd.Refresh()
	time.Sleep(time.Second * 3)
	html, err := at.Wd.PageSource()
	if err != nil {
		return
	}
	// 1、匹配精简目标
	flysnowRegexp := regexp.MustCompile(`<div id="root">(.*)</div>`)
	params := flysnowRegexp.FindStringSubmatch(html)
	// 2、解析HTML成对象
	html = strings.Join(params, "")
	reg := regexp.MustCompile(`\s{2,}|\n|\t|\r`)
	html = reg.ReplaceAllString(html, "")
	appTags := html2json.GetTags(html2json.TagUniAPP)
	rt := html2json.New(appTags)
	nodes, err := rt.Parse(html, "")
	if err != nil {
		fmt.Println("Failed Parse Html Nodes,", err)
		return
	}

	// 3、转json,再转自家结构体
	jsonstr := selm2.ToJSON(nodes)
	objs := []selm2.H2j{}
	if err = json.Unmarshal([]byte(jsonstr), &objs); err != nil {
		fmt.Println("转json,再转自家结构体", err)
		return
	}
	fmt.Println("objs", objs)
	resp = &objs[0]
	return
}
