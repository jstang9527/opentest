package thirdpart

import (
	"fmt"
	"time"

	"github.com/jstang9527/opentest/model"
	"github.com/jstang9527/opentest/utils/tools"
	"github.com/tebeka/selenium"
)

//有网络配置(默认)、自我监控、策略配置三个页面
func (t *TestTask) checkNetConf() {
	name := "load the system network"
	message := "success"
	var priority model.Level = model.High
	var status model.Level = model.Error
	start := time.Now()

	//1.找到系统配置buttom
	sysBtn, err := t.Wd.FindElement(selenium.ByXPATH, `//*[@id="root"]/div/nav/ul/li[5]`)
	if err != nil {
		message = fmt.Sprintln("sysconf buttom not found in user page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, status, time.Now().Sub(start))
		return
	}
	//2.点击系统配置
	err = sysBtn.Click()
	if err != nil {
		message = fmt.Sprintln("can't click sysconf buttom in user page.", err)
		screenshot := tools.CreateMd5(message) //截图名
		t.createItem(name, message, screenshot, priority, status, time.Now().Sub(start))
		return
	}

	//获取网络页面数据，查看数据是否加载
	for i := 0; i < 10; i++ {
		if content, err := t.Wd.FindElement(selenium.ByXPATH, `//*[@id="root"]/div/div/div[2]/div/div[1]/div/div[2]/form/div[1]/div[1]/label/span`); err != nil {
			time.Sleep(time.Millisecond * 200)
			continue
		} else if c, _ := content.Text(); c != "" {
			message = c
			break
		}
		if i == 9 {
			message := fmt.Sprintln("unable load user page data More than 10.")
			screenshot := tools.CreateMd5(message) //截图名
			t.createItem(name, message, screenshot, priority, status, time.Now().Sub(start))
			return
		}
	}

	now := time.Now()
	screenshot := tools.CreateMd5(name + start.String() + now.String() + message) //截图名
	t.createItem(name, message, screenshot, priority, model.Pass, time.Now().Sub(start))
}
