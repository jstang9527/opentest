package honeypotmanager

import (
	"fmt"
	"time"

	"github.com/jstang9527/opentest/model"
	"github.com/tebeka/selenium"
)

func checkImg(pid string, wd selenium.WebDriver) {
	name := "check honeypot img function."
	message := "success"
	var priority model.Level = model.High
	var status model.Level = model.Pass

	start := time.Now()

	//找到buttom
	sysBtn, err := wd.FindElement(selenium.ByXPATH, `//*[@id="root"]/div/nav/ul/li[5]`)
	if err != nil {
		message = fmt.Sprintln("sysconf buttom not found.", err)
		now := time.Now()
		sname := now.Format("20060102150405000")
		saveRecord(pid, name, message, sname, now.Sub(start), priority, model.Error)
		saveScreenshot(wd, sname)
		return
	}
	//点击系统配置
	err = sysBtn.Click()
	if err != nil {
		message = fmt.Sprintln("can't click sysconf buttom.", err)
		now := time.Now()
		sname := now.Format("20060102150405000")
		saveRecord(pid, name, message, sname, now.Sub(start), priority, model.Error)
		saveScreenshot(wd, sname)
		return
	}
	fmt.Println("alreay .")

	//获取网络页面数据，查看数据是否加载
	for i := 0; i < 10; i++ {
		if content, err := wd.FindElement(selenium.ByXPATH, `//*[@id="root"]/div/div/div[2]/div/div[1]/div/div[2]/form/div[1]/div[1]/label/span`); err != nil {
			time.Sleep(time.Millisecond * 200)
			continue
		} else if c, _ := content.Text(); c != "" {
			fmt.Println(c)
			break
		}
		if i == 9 {
			now := time.Now()
			sname := now.Format("20060102150405000")
			message = "check page data timeout."
			saveRecord(pid, name, message, sname, now.Sub(start), priority, model.Error)
			saveScreenshot(wd, sname)
			return
		}
	}

	now := time.Now()
	sname := now.Format("20060102150405000")
	saveRecord(pid, name, message, sname, now.Sub(start), priority, status)
	time.Sleep(time.Second * 1)
	saveScreenshot(wd, sname)
}
